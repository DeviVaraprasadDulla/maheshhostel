// js/home.js
(() => {
  // Basic helpers
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  // Year in footer
  const yearEl = document.getElementById("year");
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  /* Header shadow on scroll + fixed header already set in CSS */
  (function headerScrollHandler() {
    const header = document.querySelector(".site-header");
    if (!header) return;
    const scThreshold = 8;
    function update() {
      const sc = window.scrollY || document.documentElement.scrollTop;
      if (sc > scThreshold) header.classList.add("scrolled");
      else header.classList.remove("scrolled");
    }
    update();
    window.addEventListener("scroll", update, { passive: true });
  })();

  /* Mobile menu toggle */
  (function mobileMenu() {
    const mobileBtn = document.getElementById("mobileMenuBtn");
    const nav = document.getElementById("nav");
    if (!mobileBtn || !nav) return;
    mobileBtn.addEventListener("click", () => {
      const isOpen = mobileBtn.getAttribute("aria-expanded") === "true";
      mobileBtn.setAttribute("aria-expanded", String(!isOpen));
      nav.classList.toggle("open");
    });
    // close when nav link clicked (mobile)
    document.querySelectorAll(".nav-list a").forEach((a) => {
      a.addEventListener("click", () => {
        if (mobileBtn.getAttribute("aria-expanded") === "true")
          mobileBtn.click();
      });
    });
  })();

  /* Hero slider (accessible, autoplay, keyboard & touch) */
  (function heroSlider() {
    const imgs = Array.from(document.querySelectorAll(".hs-img"));
    const dotsWrap = document.getElementById("hsDots");
    const prev = document.getElementById("hsPrev");
    const next = document.getElementById("hsNext");
    const frame = document.getElementById("hsFrame");
    if (!imgs.length) return;

    let idx = 0;
    const delay = 4500;
    let timer = null;
    let autoplay = true;

    function setSlide(i) {
      idx = (i + imgs.length) % imgs.length;
      imgs.forEach((img) => {
        const active = parseInt(img.dataset.index, 10) === idx;
        img.datasetActive = active ? "true" : "false";
        // For accessibility: set aria-hidden
        img.setAttribute("aria-hidden", active ? "false" : "true");
      });
      if (dotsWrap) {
        Array.from(dotsWrap.children).forEach((d, di) =>
          d.setAttribute("aria-selected", di === idx ? "true" : "false")
        );
      }
    }

    function nextSlide() {
      setSlide(idx + 1);
      restart();
    }
    function prevSlide() {
      setSlide(idx - 1);
      restart();
    }
    function restart() {
      if (timer) clearInterval(timer);
      if (autoplay) timer = setInterval(() => setSlide(idx + 1), delay);
    }
    function stop() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    // create dots
    if (dotsWrap) {
      imgs.forEach((img, i) => {
        const b = document.createElement("button");
        b.className = "hs-dot";
        b.type = "button";
        b.setAttribute("role", "tab");
        b.setAttribute("aria-selected", i === 0 ? "true" : "false");
        b.setAttribute("aria-label", `Slide ${i + 1}`);
        b.addEventListener("click", () => {
          setSlide(i);
          restart();
        });
        dotsWrap.appendChild(b);
      });
    }

    if (prev) prev.addEventListener("click", prevSlide);
    if (next) next.addEventListener("click", nextSlide);

    // keyboard navigation
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") prevSlide();
      if (e.key === "ArrowRight") nextSlide();
    });

    // pause on hover/focus
    const hsFrame = frame || document.getElementById("heroSlider");
    if (hsFrame) {
      hsFrame.addEventListener("mouseenter", stop);
      hsFrame.addEventListener("mouseleave", restart);
      hsFrame.addEventListener("focusin", stop);
      hsFrame.addEventListener("focusout", restart);
    }

    // basic swipe support
    let startX = null,
      startY = null;
    if (hsFrame) {
      hsFrame.addEventListener(
        "touchstart",
        (ev) => {
          const t = ev.touches[0];
          startX = t.clientX;
          startY = t.clientY;
          stop();
        },
        { passive: true }
      );

      hsFrame.addEventListener(
        "touchend",
        (ev) => {
          if (startX === null) return;
          const t = ev.changedTouches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;
          if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
            if (dx < 0) nextSlide();
            else prevSlide();
          }
          startX = null;
          startY = null;
          restart();
        },
        { passive: true }
      );
    }

    // init: mark data-index if missing, and ensure one active
    imgs.forEach((img, i) => {
      if (typeof img.dataset.index === "undefined")
        img.dataset.index = String(i);
      // ensure default datasetActive attribute
      img.datasetActive = i === 0 ? "true" : "false";
      img.setAttribute("aria-hidden", i === 0 ? "false" : "true");
    });

    setSlide(0);
    restart();
  })();

  /* Contact form demo (replace with API call as needed) */
  (function contactDemo() {
    const form = document.getElementById("contactForm");
    if (!form) return;
    const status = document.getElementById("contactStatus");
    const submit = document.getElementById("contactSubmit");
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      if (!submit) return;
      submit.disabled = true;
      if (status) status.textContent = "Sending...";
      // simulate network call (replace with your real API POST)
      try {
        await new Promise((r) => setTimeout(r, 900));
        if (status)
          status.textContent = "Message sent â€” we will call you soon.";
        form.reset();
        setTimeout(() => {
          if (status) status.textContent = "";
        }, 4000);
      } catch (e) {
        if (status) status.textContent = "Failed to send. Try again later.";
      } finally {
        submit.disabled = false;
      }
    });
  })();
})();
